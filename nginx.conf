server {
    listen       PORT_PLACEHOLDER;
    server_name  _;

    # Vite build output
    root /usr/share/nginx/html;
    index index.html;

    # ✅ CSP: only same-origin since /api is proxied
    add_header Content-Security-Policy "default-src 'self'; connect-src 'self'; img-src 'self' data: blob: https://{s}.tile.openstreetmap.org https://tile.openstreetmap.org https://server.arcgisonline.com https://services.arcgisonline.com; style-src 'self' 'unsafe-inline'; script-src 'self'; font-src 'self' data:; worker-src 'self' blob:; frame-ancestors 'self'" always;

    gzip on;
    gzip_types text/plain text/css application/javascript application/json image/svg+xml;

    # SPA fallback
    location / {
        try_files $uri /index.html;
    }

    # 🔁 Proxy API -> Railway backend
    location /api/ {
        proxy_http_version 1.1;
        proxy_set_header   Host agrisentinel-production.up.railway.app;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   X-Forwarded-For $remote_addr;
        proxy_pass         https://agrisentinel-production.up.railway.app/;
    }
}
